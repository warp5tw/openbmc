From 4b8c5d6a84e6347ebf257ee53c0e310d3d5a1112 Mon Sep 17 00:00:00 2001
From: kfting <kfting@nuvoton.com>
Date: Wed, 17 Jul 2019 10:10:26 +0800
Subject: [PATCH] meta-evb-npcm750: Add support for LDAP login

Signed-off-by: kfting <kfting@nuvoton.com>
---
 obmc/wsgi/apps/rest_dbus.py | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/obmc/wsgi/apps/rest_dbus.py b/obmc/wsgi/apps/rest_dbus.py
index 54f9319..3199e11 100755
--- a/obmc/wsgi/apps/rest_dbus.py
+++ b/obmc/wsgi/apps/rest_dbus.py
@@ -31,6 +31,7 @@ import crypt
 import tempfile
 import re
 import mimetypes
+import pamela
 have_wsock = True
 try:
     from geventwebsocket import WebSocketError
@@ -682,7 +683,16 @@ class SessionHandler(MethodHandler):
     def authenticate(username, clear):
         try:
             encoded = spwd.getspnam(username)[1]
-            return encoded == crypt.crypt(clear, encoded)
+            if(encoded == crypt.crypt(clear,encoded)):
+                return True
+            else:
+                retval = pamela.authenticate(username,clear)
+                if(retval):
+                    pamela.open_session(username)
+                    return pamela.close_session(username)
+                else:
+                    return False
+                raise KeyError
         except KeyError:
             return False
 
-- 
2.17.1

